# 方法框架叙事 Workflow（PI 意见版）

> 目标：把“方法框架”写成一个能自圆其说的故事，而不是技术手册。

## 核心原则（叙事逻辑）

- 基金申请书的方法部分应遵循：**问题 → 思路 → 方法设计 → 技术实现 → 验证闭环**。
- 评审阅读过程中需要不断得到“为什么”的解答，而不是被“是什么”的细节淹没。
- 本文档用于写作对齐：先搭骨架，再填内容，最后做前后呼应与闭环自检。

---

## 建议的方法框架结构（5 段式）

### 结构总览

| 层次 | 内容 | 叙事功能 | 篇幅建议 |
|---|---|---|---|
| 一、研究思路与整体框架 | 问题锋利化 + 整体技术路线图 | 让专家一眼看懂“你要干什么” | 1/2 页 |
| 二、数据基础与条件构建 | 多源数据来源、作用、如何转化为生成条件 | 回答“你有什么资源可用” | 1/2 页 |
| 三、方法设计：基于扩散的多层次人口生成方法 | 方法命名、多层次内涵、物理启发机制、与已有方法的区别 | 回答“为什么这个方法能解决问题” | 1 页 |
| 四、模型架构与关键技术 | 模型组件、约束注入机制、训练策略 | 回答“具体怎么实现” | 1–1.5 页 |
| 五、验证框架 | 三层验证（统计/空间/时间）、指标设计 | 回答“怎么证明你做成了” | 1/2 页 |

---

## 详细展开（逐段写作提示）

### 一、研究思路与整体框架

本课题聚焦“可用于城市模拟与数字孪生”的建筑物尺度人口时空画像。人口画像的本质不是若干边际属性的拼接，而是在宏观统计约束与多源城市感知证据条件下，重建并采样人口“属性—空间—时间”的高维联合分布。

现有主流路线在该问题上存在结构性瓶颈：基于 IPF/IPU 的边际拟合擅长匹配控制量，但在高维稀疏下容易丢失关键关联结构，且难以补齐样本中未出现但现实存在的稀有组合；组合优化方法受候选库覆盖度限制，候选库缺失会直接变成“无解”；深度生成若把逻辑规则与层级一致性等硬约束后置（事后筛选/修补），往往造成分布结构被破坏或采样效率过低。上述问题共同指向一点：目标是“联合结构重建 + 约束满足”的一体化生成，而非先生成再事后修补。

为此，本课题提出“基于扩散的多层次人口生成方法”：利用生成式扩散模型逐步去噪的分布重建机制直接学习高维联合结构，并将普查边际（宏观约束）、建筑物/用地/POI（空间锚定）与时段信息（时间动态）作为条件持续注入生成过程；同时以硬约束渐进校正保证逻辑可行性，使“联合结构重建—约束满足”在生成过程中同步发生。

整体技术路线组织为闭环：数据 → 条件构建 → 受控生成（约束内生满足）→ 三层验证 → 误差归因与迭代。需要强调的是：这里的“受控生成”环节本身包含规则可行性保证（硬约束的渐进校正），不等同于传统“生成完毕后统一筛选/修改”的事后修补。技术路线示意如下：

```text
多源数据（普查/统计年鉴 + 建筑物/用地/POI + 信令/轨迹 + 夜光/遥感）
                         │
                         ▼
条件构建（宏观边际约束 + 空间锚定条件 + 时间动态条件）
                         │
                         ▼
受控生成：基于扩散的多层次生成
（属性→空间→时间 三层级联；约束内生满足）
                         │
                         ▼
输出：建筑物尺度人口时空画像（可生成、可检验、可用于仿真）
                         │
                         ▼
验证闭环（统计一致性 / 空间真实性 / 时间动态匹配）→ 定位偏差来源 → 迭代改进
```

基于上述总体框架，第二部分进一步说明：这些多源数据如何被规范化、对齐，并转化为生成模型可用的“条件”与“约束”。

---

### 二、数据基础与条件构建

本课题的数据体系遵循一个基本原则：多源数据既用于**约束生成目标**，也用于**构造生成条件**。换言之，数据不是“生成之后再去评估的证据”，而是“生成过程中持续告诉模型往哪里生成的信号”。为避免“堆数据而不成体系”，我们将多源数据按其在生成中的功能划分为三类条件与一类独立验证证据。

| 数据类型 | 典型来源（示例） | 在生成中的作用 |
|---|---|---|
| 人口普查/统计年鉴 | 普查、统计年鉴、相关专项统计 | **宏观边际约束**：限定区域尺度总体结构与规模 |
| 建筑物/用地/POI | 建筑物矢量、用地数据、POI（公开/商业） | **空间锚定条件**：限定“人落在哪里、落点是什么功能空间” |
| 手机信令/轨迹/位置数据 | 运营商信令、互联网位置数据等（需合作/授权） | **时间动态条件**：限定日/周周期的活动强度与时段差异 |
| 夜间灯光/遥感/网格证据 | 夜光、遥感产品、网格证据等 | **独立核验**：为空间真实性与时间动态提供外部参照 |

为把上述数据真正转化为“可控生成”的条件，关键不在于“数据更多”，而在于“数据能对生成起作用”。如果尺度与口径不统一，多源信息就只能在生成之后被动评估；而一旦对齐到同一套基准，它们就能在生成过程中持续回答“往哪里生成、生成多少、生成到哪里、何时生成”的问题。

空间上，本课题以行政区/街道等统计单元承载宏观约束，以建筑物承载微观生成，将建筑物与用地、POI 等要素进行关联，提取可解释的建筑条件特征（功能、形态、周边活跃度等）；时间上，将信令/轨迹等动态证据统一到少量可解释的时间切片（如日间/夜间、工作日/周末），提取区域或建筑物尺度的时段活动强度与分布作为时间条件。

属性上，人口变量的类别体系与普查边际保持一致，确保“宏观约束—微观样本—生成输出”可直接对照与验收。在此基础上，将宏观边际、建筑条件、时段条件分别编码为区域/建筑/时段条件输入，并明确“哪个数据约束哪个生成维度”，为后续的软约束引导、硬约束渐进校正与误差归因提供可追踪接口。

通过上述条件构建，本课题形成“宏观统计约束 + 空间锚定 + 时间动态”的统一条件体系，为第三部分的方法设计提供数据基础。

---

### 三、方法设计：基于扩散的多层次人口生成方法

本部分的任务不是罗列模型细节，而是回答一个评审最关心的问题：**为什么“扩散 + 多层次 + 约束内生”能够在本课题的现实数据条件下解决问题**。核心逻辑是：人口画像要重建的是“联合结构”，而联合结构的学习与约束满足必须在生成过程中同步发生。

#### 3.1 方法命名与核心思想

**方法命名**：基于扩散的多层次人口生成方法。

**一句话定义**：在宏观统计与多源时空条件约束下，采用生成式扩散模型重建人口“属性—空间—时间”的联合分布，并以多层次生成与约束注入机制输出建筑物尺度、具时间动态的人口画像。

**与传统方法的本质区别**：传统路线主要通过“边际调权/候选组合/事后修补”间接逼近目标；本课题将问题直接表述为“在约束下重建联合分布并采样”，并把约束作为生成动力学的一部分，使生成过程同时追求（i）联合结构的真实性，（ii）宏观一致性，（iii）微观可行性。

#### 3.2 “多层次”的内涵

**为什么需要多层次**：直接在一个平坦空间里联合生成“属性 × 空间 × 时间”会遭遇维度灾难与层级约束冲突：一方面，高维交叉空间天然稀疏；另一方面，家庭—个体一致性、建筑容量/功能约束、昼夜动态约束具有明确的层级依赖关系，必须通过“由上到下、由粗到细”的结构化生成才能可控。

**三重层次**：本课题的“多层次”包含三类互相耦合的层次分解：
- **属性层次**：家庭结构 → 个体成员属性（先“骨架”，后“细节”），以保证家庭—个体一致性。
- **空间层次**：区域（统计单元）→ 建筑物 → 个体落点，以保证宏观边际与建筑物尺度空间锚定同时成立。
- **时间层次**：静态基底（常住/在地）→ 时段分布（在时/动态），以保证昼夜与工作日/周末规律可控生成。

**层次之间的条件依赖**：下游层的生成以“上游层输出 + 条件构建（第二部分）”为输入。例如，个体属性生成以家庭结构与区域边际为条件；个体落点生成以建筑物功能与容量为条件；时间动态生成以信令/时段强度为条件。

#### 3.3 物理启发机制（可选，视篇幅）

扩散模型可以理解为一种“逐步修正”的生成方式：从一个易采样的初始状态出发，通过多次小步去噪逐渐恢复到目标结构。对本课题而言，小步迭代带来两个直接好处：一是便于把宏观边际、空间锚定与时段条件作为引导信号持续注入，而不是一次性硬塞进最终输出；二是便于在生成过程中持续执行硬约束的渐进校正，从而把可行性保证内生到生成动力学中，而非依赖事后修补。

#### 3.4 与已有方法的区别

为避免重复已有综述，这里以“评审最关心的差异点”为主做对照总结：

| 路线 | 更擅长解决什么 | 关键短板 | 本课题的关键改进 |
|---|---|---|---|
| 分层边际拟合（IPF/IPU/HIPF） | 匹配边际控制量、可解释 | 高维联合结构易丢失；对样本支持集敏感 | 用扩散直接学习联合结构，并以软约束引导保证宏观可验收 |
| 候选库/组合优化 | 可嵌入规则约束 | 覆盖度受限，候选缺失即“无解”；效率受限 | 不依赖候选库穷举，硬约束在采样中渐进校正以保持结构一致性 |
| 表格扩散（仅属性合成） | 学习属性联合分布 | 缺少空间锚定、层级一致性与动态约束闭环 | 扩展为“属性—空间—时间”多层次受控生成，并配套三层验证闭环 |

因此，本课题的方法设计以“联合结构重建 + 约束内生满足”为主线，既解释“为什么可行”，也为后续的工程落地提供清晰接口。

---

### 四、模型架构与关键技术

本部分给出可落地的实现路线：生成对象如何表示、生成流程如何分解、约束如何注入、以及训练如何组织。叙事的核心仍然是“为什么这样设计能解决前述问题”，而不是把实现细节堆满正文。

#### 4.1 生成对象与表示

**生成对象**：以“家庭—个体”为基本生成单元，并在个体记录中显式包含空间与时间变量，从而形成可用于仿真的微观数据库。

**变量类型与表示**：
- **离散属性**：年龄段、性别、受教育程度、职业类别、家庭类型等，采用类别编码/嵌入表示；
- **连续属性**：收入等，采用连续变量表示（必要时做分段或标准化）；
- **空间变量**：区域标识与建筑物标识（或建筑物类型/功能），以及由建筑物/用地/POI 构成的空间条件特征；
- **时间变量**：时段（日间/夜间、工作日/周末等）与活动强度/出现概率等动态表征。

**分层结构**：生成过程遵循“家庭 → 个体 → 空间 → 时间”的层级依赖：先保证家庭层一致性，再生成个体属性；先锚定静态落点，再生成时段动态。

#### 4.2 生成流程

为降低一次性联合生成的难度并提升可控性，本课题采用级联/分层的生成流程，将任务拆为可解释的子问题：

1. **区域层（宏观一致性）**：在普查边际约束下，生成或校准区域尺度的人口总体结构（关键属性边际与必要的二阶关联），作为下游生成的“宏观边界条件”。
2. **建筑层（空间锚定）**：在建筑物/用地/POI 条件下，将区域结构下推到建筑物尺度，形成建筑物层的容量与结构先验（哪些建筑更可能承载哪类人群）。
3. **家庭—个体层（属性一致性）**：先生成家庭结构（户规模/家庭类型等），再在家庭条件下生成成员属性，确保户—人逻辑一致。
4. **时间层（动态补全）**：在手机信令/轨迹/时段强度条件下，为个体生成时段状态（如日间/夜间位置或活动强度），实现从静态“在地人口”到动态“在时人口”的统一建模。

**条件引导的落地方式**：第二部分构建的宏观边际、空间锚定、时间动态三类条件被统一编码为模型条件输入，贯穿上述各层生成过程；从叙事上明确“哪个数据约束哪个维度”，从实现上保证“条件可控、可解释、可追踪”。

#### 4.3 约束注入机制

人口合成约束具有层次性：宏观统计允许一定误差（软约束），而逻辑规则与结构性零不可违反（硬约束）。因此，本课题采用“软约束引导 + 硬约束渐进校正”的组合机制，把“统计可验收”与“逻辑可行”同时写进生成过程。

**软约束引导（宏观统计）**：将生成样本在区域尺度的聚合统计与普查/年鉴目标统计的差异转化为引导信号，在去噪采样过程中持续把生成分布拉回目标附近；软约束主要作用于区域层与关键属性结构，确保生成总体在统计口径上可验收。

**硬约束渐进校正（规则/层级一致性）**：对结构性零与层级逻辑（如年龄–就业一致性、家庭结构一致性、建筑容量/功能约束等）进行规则检查；一旦局部变量违反规则，执行“投影/局部重采样”等最小必要操作将其拉回可行域，并在采样迭代中重复执行。这里的“投影”指在规则定义的可行集合上，对少量字段做最小改动以满足规则（必要时局部重采样），而不是生成完成后统一筛选/修改的事后修补；渐进校正与去噪同步发生，能尽量保留已学习的联合结构并提升采样效率。

该机制的要点在于：软约束塑造“总体结构”，硬约束限定“可行边界”，两者协同使约束满足内生到生成动力学中。

**约束注入的最小伪代码（评审可读版）**：将“去噪一步”写成“生成 + 拉回 + 纠偏”的重复迭代，而不是“生成完再筛选”。

```text
Inputs:
  condition c                 # 多源条件（宏观边际/空间锚定/时段信息的编码）
  targets M                   # 目标统计（分区边际与关键二阶关联）
  rules R                     # 结构性零与逻辑规则（可行域）
  denoiser εθ(·|c,t)          # 去噪网络（学习联合结构）

Initialize x_T ~ N(0, I)      # 从噪声出发
for t = T ... 1:
  x_{t-1} ← DDPM_step(x_t, εθ, c, t)        # 基于 score 的去噪更新（重建联合结构）
  x_{t-1} ← SoftGuide(x_{t-1}, M, t)        # 软约束：把宏观统计偏差持续拉回目标附近
  x_{t-1} ← ProjectHard(x_{t-1}, R)         # 硬约束：对违规字段做最小必要修正/局部重采样
return x_0
```

**实现上的 v0 简化策略（工程可落地）**：软约束可先采用“分批采样 → 聚合评估 → 重加权/重采样”的简化版本；硬约束可先采用“规则检查 → 违规字段局部修正”的局部投影版本，在保证可行性的前提下先把闭环跑通。

#### 4.4 训练策略

**数据准备**：
- 统一变量口径与类别体系（与普查统计口径一致），并完成空间/时间对齐；
- 将多源数据整理为“条件—目标”形式：条件来自第二部分的三类条件构建，目标为可获取的微观样本或可用于学习联合结构的训练样本（来源取决于可访问的数据与合作范围）。

**损失与目标**：训练目标以“联合结构学习”为主，并通过条件化训练让模型学会在不同区域/建筑/时段条件下生成差异化人群结构；约束的实现遵循“训练期学结构、推断期受控采样”的分工：训练期主要学习联合结构与条件响应，推断期通过软约束引导与硬约束渐进校正实现“可控与可行”。

**训练组织（建议叙事）**：整体遵循“先结构、后条件、再受控采样”的逻辑：先在可获得的微观样本上学习人口属性与家庭层的一般联合结构；再引入区域/建筑/时段条件进行条件适配，使模型学会对不同城市环境作出响应；最后在采样阶段启用软约束引导与硬约束渐进校正，并以第五部分的三层验证结果作为诊断信号，回溯调整条件构建、引导强度与规则库，从而形成可收敛的迭代过程。

---

### 五、验证框架

本课题在“缺乏建筑物尺度微观真值”的现实条件下，把“真实性”写成可检验的指标体系，构建统计—空间—时间三层验证闭环。验证的核心原则是：**你用什么条件引导，就用什么指标验证**；若验证不通过，能够定位到对应的条件或约束环节并迭代修正。

| 验证层 | 验证对象 | 核心指标（建议） | 可扩展指标（可选） | 数据来源 |
|---|---|---|---|---|
| 统计层 | 宏观一致性与关键关联 | **分区边际误差**；**关键二阶关联保持**；**硬约束违规率** | 更高阶关联保持、分布距离等 | 普查/年鉴（控制量） |
| 空间层 | 建筑物尺度空间真实性 | **用地/POI 功能一致性** | 夜间灯光/活跃度一致性、热点/排序一致性 | POI/用地/夜光/空间证据 |
| 时间层 | 时空动态规律匹配 | **日/周周期相似度** | 通勤峰值与昼夜差异、时段热点迁移一致性 | 信令/轨迹/动态人口证据 |

为避免指标堆砌导致“承诺过多”，本课题把以上 5 项作为核心验收指标，其余作为诊断与扩展指标，在篇幅允许时再展开。

**核心指标的计算形式（可复现口径）**：

1) 分区边际误差（示例：SRMSE）

$$
\\mathrm{SRMSE}
=
\\sqrt{\\frac{1}{N}\\sum_{i=1}^{N}\\left(\\frac{p_i - t_i}{t_i + \\epsilon}\\right)^2}
$$

其中 $t_i$ 为普查/年鉴目标统计，$p_i$ 为生成统计，$N$ 为类别数，$\\epsilon$ 为避免分母为 0 的极小常数。

2) 关键二阶关联保持（示例：相关系数偏差/保持率）

$$
\\Delta\\rho = \\left|\\rho_{\\mathrm{syn}}(X,Y) - \\rho_{\\mathrm{true}}(X,Y)\\right|,
\\qquad
\\mathrm{Keep}(\\rho)=\\frac{\\rho_{\\mathrm{syn}}(X,Y)}{\\rho_{\\mathrm{true}}(X,Y)+\\epsilon}
$$

其中 $X,Y$ 可取收入–职业、居住地–就业地等关键耦合对。

3) 硬约束违规率

$$
\\mathrm{ViolRate} = \\frac{\\#\\{\\text{violations}\\}}{\\#\\{\\text{samples}\\}}
$$

4) POI 功能一致性（示例：空间相关）

对每个空间单元 $u$（如 BG/建筑邻域），计算生成居住人口 $P_u$ 与居住型 POI 密度 $D_u$，以 Spearman/Pearson 相关作为一致性度量：

$$
\\mathrm{POIAlign} = \\rho(P, D)
$$

5) 时间层相似度（示例：日周期曲线余弦相似）

$$
\\mathrm{CosSim}(s,r) = \\frac{s\\cdot r}{\\|s\\|\\,\\|r\\|}
$$

**统计层（回答“总体像不像”）**：在区域尺度对齐普查边际与关键联合统计，重点检查“边际一致但关联丢失”的问题；同时统计结构性零（不可行组合）比例，确保规则可行性不靠事后丢弃来达成。

**空间层（回答“落点对不对”）**：在建筑物尺度检验生成落点是否与城市形态证据一致，例如：居住/就业相关人群在相应用地与 POI 周边的聚集程度、与夜间灯光强度的空间一致性等。空间层的目的不是追求单一回归指标，而是检验“锚定条件是否真的限制了落点”。

**时间层（回答“动态像不像”）**：对比生成的日/周周期曲线与外部动态数据揭示规律（如昼夜差异、工作日/周末差异、通勤时段峰值），并检验热点在不同时间段的迁移是否合理。

**闭环迭代（回答“哪里错了、怎么改”）**：若出现偏差，可按层定位并回溯到方法环节：
- 统计层偏差：回溯宏观边际约束与软约束引导强度；
- 空间层偏差：回溯空间锚定条件构建与建筑物先验；
- 时间层偏差：回溯时段条件构建与动态生成模块。

通过三层验证与误差归因，本课题形成可收敛的“生成—验证—改进”闭环，保证方法不仅能生成数据，更能被检验与迭代。

---

## 叙事流程图（写作顺序）

```text
┌──────────────────────────────────────────────────────────────┐
│  一、研究思路 │ 问题 → 现有方法瓶颈 → 本课题思路 → 技术路线图 │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│  二、数据基础 │ 普查 + 建筑物/POI + 信令 + 遥感 → 转化为生成条件 │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│  三、方法设计 │ 方法定义 → 多层次内涵 → 物理启发 → 与已有方法区别 │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│  四、模型架构 │ 生成对象 → 生成流程 → 约束注入 → 训练策略         │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│  五、验证框架 │ 统计层 → 空间层 → 时间层 → 闭环迭代               │
└──────────────────────────────────────────────────────────────┘
```

---

## 下一步建议（执行方式）

1. **先写结构**：在申报书方法部分先建立以上 5 段式骨架与小标题。
2. **分段填充**：从“一、研究思路”开始，逐段填充，避免先写细节导致散。
3. **前后对照**：确保每一部分都与前文综述、后文创新点呼应，并能落到验证闭环。
